import { save } from './modules/api.js';
import { parseContent } from './modules/parser.js';
import { renderColumns } from './modules/ui.js';
import { renderCalendar } from './modules/calendar.js';
import { bindEditorEvents, highlightLine, insertAtCursor } from './modules/editor.js';

export class App {
    constructor() {
        const data = window.SERVER_DATA || {};
        this.slug = data.slug;
        this.content = data.content || '';
        this.updatedAt = data.updated_at || null;
        this.allSlugs = data.allSlugs || [];
        this.defaultConfig = {
            locale: 'de-DE', 
            view: 'week', 
            sorts: {},
            theme: 'dark', 
            calHeight: 50, 
            defDuration: 20, 
            ganttMinWidth: 60,
            calStartHour: 0, 
            calEndHour: 24,
            visibleDays: [1,2,3,4,5,6,0],
            prioColors: ['#ff4d4d', '#ff9e4d', '#ffd24d', '#4dff88', '#4d9eff'],
            markerColors: ['#e06c75', '#d19a66', '#e5c07b', '#98c379', '#56b6c2', '#61afef', '#c678dd', '#be5046', '#abb2bf']
        };
        this.config = { ...this.defaultConfig, ...(data.config || {}) };

        this.dom = {
            editor: document.getElementById('editor'),
            status: document.getElementById('save-status'),
            tasks: document.getElementById('render-tasks'),
            notes: document.getElementById('render-notes'),
            dates: document.getElementById('render-dates'),
            calRender: document.getElementById('calendar-render'),
            genPreview: document.getElementById('gen-preview'),
            // NEU: Banner Container
            banner: document.getElementById('update-banner')
        };
        this.calState = { refDate: new Date() };
        this.saveTimeout = null;
        
        // NEU: States für Update-Check
        this.lastInputTime = 0; 
        this.checkInterval = null;

        if(this.dom.editor) {
            this.dom.editor.value = this.content;
            this.applyGlobalSettings();
            this.initEvents();
            this.runPipeline();
            // NEU: Heartbeat starten
            this.initHeartbeat();
        }
    }

    applyGlobalSettings() {
        const root = document.documentElement;
        const c = this.config;
        
        if(c.theme === 'light') {
            root.style.setProperty('--bg-dark', '#f5f5f5');
            root.style.setProperty('--bg-panel', '#ffffff');
            root.style.setProperty('--border', '#e0e0e0');
            root.style.setProperty('--text-main', '#333333');
            root.style.setProperty('--text-muted', '#666666');
            if(this.dom.editor) this.dom.editor.style.color = '#333';
        } else {
            root.style.setProperty('--bg-dark', '#1e1e1e');
            root.style.setProperty('--bg-panel', '#252526');
            root.style.setProperty('--border', '#3e3e42');
            root.style.setProperty('--text-main', '#d4d4d4');
            root.style.setProperty('--text-muted', '#858585');
            if(this.dom.editor) this.dom.editor.style.color = '#ce9178';
        }

        if(c.prioColors && c.prioColors.length === 5) {
            c.prioColors.forEach((col, i) => {
                root.style.setProperty(`--prio-${i+1}`, col);
            });
        }
        
        // Apply Marker Colors
        if(c.markerColors && c.markerColors.length === 9) {
            c.markerColors.forEach((col, i) => {
                root.style.setProperty(`--marker-${i+1}`, col);
            });
        }

        if(c.calHeight) {
            root.style.setProperty('--cal-height', `${c.calHeight}%`);
        }
    }

    initEvents() {
        bindEditorEvents(this.dom, {
            onInput: (newContent) => {
                this.content = newContent;
                // NEU: Zeitstempel der letzten Eingabe setzen
                this.lastInputTime = Date.now();
                this.dom.status.textContent = '...';
                
                // Banner ausblenden, falls User weitertippt, 
                // da er ja gerade eine "noch neuere" Version lokal erzeugt
                // (Wird beim nächsten Save dann ggf. zum Konflikt führen, aber das ist gewollt)
                
                this.runPipeline();
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.triggerSave(), 1000);
            }
        });

        document.body.addEventListener('click', (e) => {
            const sortBtn = e.target.closest('button[data-sort]');
            if(sortBtn) {
                const type = sortBtn.dataset.sort;
                const current = this.config.sorts[type] || 'default';
                this.config.sorts[type] = current === 'default' ? 'asc' : (current === 'asc' ? 'desc' : 'default');
                this.runPipeline();
                this.triggerSave();
            }

            const viewBtn = e.target.closest('.view-btn');
            if(viewBtn) {
                this.config.view = viewBtn.dataset.view;
                this.runPipeline();
                this.triggerSave();
            }

            if(e.target.closest('#cal-prev')) {
                const d = new Date(this.calState.refDate);
                d.setDate(d.getDate() - 7);
                this.calState.refDate = d;
                this.runPipeline();
            }
            if(e.target.closest('#cal-next')) {
                const d = new Date(this.calState.refDate);
                d.setDate(d.getDate() + 7);
                this.calState.refDate = d;
                this.runPipeline();
            }
            if(e.target.closest('#cal-today')) {
                this.calState.refDate = new Date();
                this.runPipeline();
            }

            const itemTarget = e.target.closest('.card, .cal-event, .cal-strip, .g-bar-item, .g-task-row');
            if(itemTarget && itemTarget.dataset.id) {
                highlightLine(this.dom, parseInt(itemTarget.dataset.id));
            }

            if(e.target.id === 'btn-s-date') document.getElementById('pick-s-date').showPicker();
            if(e.target.id === 'btn-s-time') document.getElementById('pick-s-time').showPicker();
            if(e.target.id === 'btn-e-date') document.getElementById('pick-e-date').showPicker();
            if(e.target.id === 'btn-e-time') document.getElementById('pick-e-time').showPicker();
            
            // NEU: Button im Banner
            if(e.target.id === 'btn-load-remote') {
                 // Seite neu laden ist am sichersten, um alles konsistent zu holen
                 // Aber um SPA-Feeling zu behalten:
                 window.location.reload(); 
            }
        });

        this.bindModalEvents();
    }

    bindModalEvents() {
        const toggle = (id, show) => {
            const el = document.getElementById(id);
            if(show) el.classList.add('open'); 
            else el.classList.remove('open');
        };

        document.getElementById('btn-recur')?.addEventListener('click', () => { 
            toggle('modal-recur', true); 
            this.updateGenPreview(); 
        });
        document.getElementById('btn-help')?.addEventListener('click', () => toggle('modal-help', true));
        document.getElementById('btn-settings')?.addEventListener('click', () => { 
            this.populateSettingsForm(); 
            toggle('modal-settings', true); 
        });
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', (e) => toggle(e.target.closest('.modal-overlay').id, false));
        });
        document.querySelectorAll('#modal-recur input, #modal-recur select').forEach(el => 
            el.addEventListener('input', () => this.updateGenPreview()));
        document.getElementById('btn-insert-recur')?.addEventListener('click', () => {
            const tag = this.dom.genPreview.textContent;
            toggle('modal-recur', false);
            insertAtCursor(this.dom.editor, ' ' + tag, (val) => {
                this.content = val;
                this.lastInputTime = Date.now(); // Auch hier Check pausieren
                this.runPipeline();
                this.triggerSave();
            });
        });
        document.getElementById('btn-save-settings')?.addEventListener('click', () => {
            this.config.theme = document.getElementById('set-theme').value;
            this.config.calHeight = parseInt(document.getElementById('set-cal-height').value);
            this.config.defDuration = parseInt(document.getElementById('set-def-dur').value);
            this.config.ganttMinWidth = parseInt(document.getElementById('set-gantt-min').value);
            this.config.calStartHour = parseInt(document.getElementById('set-cal-start').value);
            this.config.calEndHour = parseInt(document.getElementById('set-cal-end').value);
            
            const days = [];
            document.querySelectorAll('.set-day-chk:checked').forEach(el => days.push(parseInt(el.value)));
            this.config.visibleDays = days;

            const colors = [];
            for(let i=1; i<=5; i++) colors.push(document.getElementById(`set-p${i}`).value);
            this.config.prioColors = colors;
            
            const mColors = [];
            for(let i=1; i<=9; i++) mColors.push(document.getElementById(`set-m${i}`).value);
            this.config.markerColors = mColors;

            this.applyGlobalSettings();
            this.runPipeline();
            this.triggerSave();
            toggle('modal-settings', false);
        });

        document.getElementById('btn-reset-settings')?.addEventListener('click', () => {
            if(!confirm('Einstellungen wirklich zurücksetzen?')) return;
            this.config = { ...this.defaultConfig };
            this.populateSettingsForm();
            this.applyGlobalSettings();
            this.runPipeline();
            this.triggerSave();
        });
        document.getElementById('btn-conflict-overwrite')?.addEventListener('click', () => {
             this.updatedAt = document.getElementById('conflict-server-ts').dataset.ts;
             document.getElementById('modal-conflict').classList.remove('open');
             this.triggerSave();
        });
        document.getElementById('btn-conflict-load')?.addEventListener('click', () => {
             this.content = document.getElementById('conflict-server-content').value;
             this.updatedAt = document.getElementById('conflict-server-ts').dataset.ts;
             this.dom.editor.value = this.content;
             this.runPipeline();
             document.getElementById('modal-conflict').classList.remove('open');
             this.dom.status.textContent = 'Server-Version geladen';
             
             // Banner auch verstecken, falls offen
             this.dom.banner.classList.remove('show');
        });
        document.getElementById('set-cal-height')?.addEventListener('input', (e) => {
            document.getElementById('val-cal-height').textContent = e.target.value + '%';
        });
    }

    populateSettingsForm() {
        const c = this.config;
        document.getElementById('set-theme').value = c.theme || 'dark';
        document.getElementById('set-cal-height').value = c.calHeight || 50;
        document.getElementById('val-cal-height').textContent = (c.calHeight||50) + '%';
        document.getElementById('set-def-dur').value = c.defDuration || 20;
        document.getElementById('set-gantt-min').value = c.ganttMinWidth || 60;
        document.getElementById('set-cal-start').value = c.calStartHour ?? 0;
        document.getElementById('set-cal-end').value = c.calEndHour ?? 24;
        document.querySelectorAll('.set-day-chk').forEach(el => {
            el.checked = (c.visibleDays || []).includes(parseInt(el.value));
        });
        if(c.prioColors) {
            c.prioColors.forEach((col, i) => {
                const el = document.getElementById(`set-p${i+1}`);
                if(el) el.value = col;
            });
        }
        if(c.markerColors) {
            c.markerColors.forEach((col, i) => {
                const el = document.getElementById(`set-m${i+1}`);
                if(el) el.value = col;
            });
        }
    }

    updateGenPreview() {
        let tag = "";
        const days = Array.from(document.querySelectorAll('.day-chk:checked')).map(el => el.value);
        
        if(days.length > 0) {
            tag = `[w ${days.join(',')}]`;
        } else {
            const intNum = document.getElementById('gen-interval-num').value;
            const intType = document.getElementById('gen-interval-type').value;
            if(intNum) {
                tag = `[w +${intNum}${intType}]`;
            } else {
                const fixDay = document.getElementById('gen-fix-day').value;
                const fixMonth = document.getElementById('gen-fix-month').value;
                if(fixDay) {
                    tag = `[w ${fixDay.padStart(2,'0')}${fixMonth ? '.'+fixMonth : ''}]`;
                }
            }
        }
        
        const bisDate = document.getElementById('gen-end-date').value;
        if(bisDate && tag) tag += ` [bis ${bisDate}]`;
        
        this.dom.genPreview.textContent = tag || "[w ...]";
    }

    runPipeline() {
        const items = parseContent(this.content, this.config);
        renderColumns(items, this.config, this.dom);
        renderCalendar(items, this.config, this.dom, this.calState);
    }

    // NEU: Heartbeat Funktion
    initHeartbeat() {
        if(this.checkInterval) clearInterval(this.checkInterval);
        
        this.checkInterval = setInterval(async () => {
            // 1. Prüfen ob gerade getippt wird (oder vor < 2000ms getippt wurde)
            const timeSinceInput = Date.now() - this.lastInputTime;
            if (timeSinceInput < 2000) {
                return; // Check überspringen
            }

            try {
                const res = await fetch(`/api/check/${this.slug}`);
                if(res.ok) {
                    const json = await res.json();
                    // Wenn Server TS neuer ist als unser lokaler 'updatedAt'
                    // Hinweis: updatedAt ist ein String aus DB 'YYYY-MM-DD HH:MM:SS'
                    // String Vergleich funktioniert bei ISO/SQL Format lexikalisch korrekt
                    if (json.updated_at > this.updatedAt) {
                        this.dom.banner.classList.add('show');
                    } else {
                         this.dom.banner.classList.remove('show');
                    }
                }
            } catch(e) {
                console.warn("Heartbeat failed", e);
            }
        }, 2000); // Alle 2 Sekunden
    }

    async triggerSave() {
        const newTs = await save(this.slug, this.content, this.config, this.updatedAt, (serverData) => {
            this.dom.status.textContent = 'Konflikt!';
            document.getElementById('conflict-server-content').value = serverData.server_content;
            const tsEl = document.getElementById('conflict-server-ts');
            tsEl.textContent = new Date(serverData.server_updated_at).toLocaleString();
            tsEl.dataset.ts = serverData.server_updated_at;
            document.getElementById('modal-conflict').classList.add('open');
            
            // Wenn Konfliktmodal offen ist, brauchen wir das kleine Banner nicht
            this.dom.banner.classList.remove('show');
        });

        if(newTs) {
            this.updatedAt = newTs;
            this.dom.status.textContent = 'Gespeichert';
            // Nach erfolgreichem Speichern sind wir wieder aktuell
            this.dom.banner.classList.remove('show');
        }
    }
}

new App();